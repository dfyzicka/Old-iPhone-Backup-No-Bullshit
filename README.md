## <a name="russian"></a>Русский

### Предыстория
Дано: **iPhone 7 Plus на 512 ГБ** и **Windows 11**.
Задача: Скинуть всё медиа (папку DCIM) на комп.
Проблема: Это ад.
* Проводник зависает при попытке скопировать всё разом.
* Процесс прерывается ошибкой «Устройство недоступно» в рандомном месте без логов.
* Окно копирования висит вечно на «Вычисление времени...».

Стандартный командлет PowerShell `Copy-Item` не работает с MTP-устройствами, так как пути типа `Этот компьютер\iPhone\...` виртуальные. Мне нужно было решение, которое копирует рекурсивно, сохраняет структуру папок `DCIM\100APPLE`, фильтрует странные дубликаты и не падает на больших видеофайлах.

### Техническое решение
Скрипт использует Windows **Shell.Application** COM-объект для работы с драйвером MTP, но с особой логикой, найденной методом проб и ошибок:

*   **Режим «Пулемета» (Burst Mode):** Вместо того чтобы ждать завершения каждого файла (слишком медленно) или отправлять тысячи команд сразу (драйвер падает), скрипт отправляет команды копирования пачками по **19 файлов**, затем делает паузу **3 секунды**. Можно попробовать увеличить скорость, но мне было лень, поэтому оставил так.
*   **Нативная очередь Windows:** Для маленьких файлов (фото) пачки пролетают быстро. Для больших файлов (видео) Windows сама открывает нативное диалоговое окно копирования, автоматически блокируя скрипт, пока ресурсы не освободятся. Это работает как естественный балансировщик нагрузки. Звучит как костыли — так оно и есть, но работает.
*   **Фильтр фантомных дублей:** iPhone часто показывает один и тот же файл дважды через MTP (например, `IMG_0404.AAE` дублируется). Скрипт фильтрует дубликаты по имени, чтобы предотвратить надоедливые окна «Файл уже существует».

### Как использовать

**1. Скачайте `Backup-iPhone.ps1`.**

**2. При необходимости подкрутите настройки в начале файла:**
   ```powershell
   $BatchSize = 19        # Сколько файлов кидать за раз
   $BatchDelaySec = 3     # Пауза между пачками (сек)
  ```
**3.Запустите в PowerShell:**
```
# Обычный запуск (AAE копируются)
.\Backup-iPhone.ps1 -DestRoot "E:\Backup"

# Не копировать мусор .AAE
.\Backup-iPhone.ps1 -DestRoot "E:\Backup" -SkipAAE

# Если запускаете не первый раз: включить пропуск узе скопированных файлов
.\Backup-iPhone.ps1 -DestRoot "E:\Backup" -SkipExisting

# Если упало на половине: Начать с папки 105APPLE + пропуск предыдущих
.\Backup-iPhone.ps1 -DestRoot "E:\Backup" -StartFolder "105APPLE" -SkipExisting
```

| Параметр      | Описание                                          | По умолчанию            |
| ------------- | ------------------------------------------------- | ----------------------- |
| -PhoneName    | Имя устройства в "Этот компьютер"                 | "Apple iPhone"          |
| -SourcePath   | Внутренний путь к медиа                           | "Internal Storage\\DCIM" |
| -DestRoot     | Папка назначения на ПК                            | "E:\\iPhone_Backup"     |
| -SkipExisting | Пропускать уже существующие файлы на диске ПК     | False                   |
| -SkipAAE      | Не копировать файлы .AAE                          | False                   |
| -StartFolder  | Имя папки, с которой начать (например "105APPLE") | "" (с начала)           |


### FAQ / Частые вопросы
Q: Скрипт пишет "Sent", но файлов в папке нет?
A: Подождите. Скрипт отправляет команды в очередь Windows. Если файлов много, Windows может обрабатывать их с задержкой. Не отключайте телефон сразу после завершения скрипта, дайте ему еще минут 5-10 на "дописывание" хвостов.

Q: Зачем нужны файлы .AAE?
A: Это файлы метаданных с вашими правками (фильтры, кадрирование). На Windows они бесполезны (ПК видит только оригинал). Вы можете отключить их копирование флагом -SkipAAE.

### Disclaimer
Используйте на свой страх и риск. Скрипт только создает копии ваших файлов. Он ничего не удаляет с исходного устройства.
